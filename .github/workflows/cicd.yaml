name: CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
      - dev
      - feat/work-schedule
  pull_request:
    branches:
      - main
      - dev

env:
  REGISTRY: ghcr.io                        # GitHub Container Registry
  OWNER: ${{ github.repository_owner }}    # ì¡°ì§/ì‚¬ìš©ì ìë™ ì°¸ì¡°
  IMAGE_NAME: ${{ github.repository_owner }}/commutemate-server  # Helm valuesì˜ springApp.imageì™€ ì¼ì¹˜í•˜ë„ë¡ ì„¤ì •

jobs:
  # ===================================================================
  # Job 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (build-and-pushì™€ ë³‘ë ¬ ì‹¤í–‰)
  # ===================================================================
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'           # Java 17 ì‚¬ìš©
          distribution: 'temurin'      # Eclipse Temurin ë°°í¬íŒ
          cache: 'gradle'              # Gradle ìºì‹± í™œì„±í™”

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 4. Gradle í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë¹Œë“œ ìºì‹œ í™œì„±í™”)
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --no-daemon --build-cache
        env:
          GRADLE_BUILD_CACHE_ENABLED: true

      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ì—…ë¡œë“œ)
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/

  # ===================================================================
  # Job 2: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCR í‘¸ì‹œ (testì™€ ë³‘ë ¬ ì‹¤í–‰)
  # ===================================================================
  build-and-push:
    name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    # needs ì œê±° - testì™€ ë³‘ë ¬ ì‹¤í–‰
    # PRì¸ ê²½ìš° ë¹Œë“œë§Œ í•˜ê³  pushëŠ” í•˜ì§€ ì•ŠìŒ
    if: github.event_name == 'push'

    # GHCR ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read      # ì†ŒìŠ¤ ì½”ë“œ ì½ê¸°
      packages: write     # GHCRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      id-token: write
      attestations: write

    # ë‹¤ìŒ Jobì— ì „ë‹¬í•  ì¶œë ¥ê°’
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build-and-push.outputs.digest }}

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. BuildKit ì„¤ì • (OCI í‘œì¤€ ì´ë¯¸ì§€ ë¹Œë“œ)
      - name: BuildKit ì„¤ì •
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      # 3. GHCR ë¡œê·¸ì¸ (GITHUB_TOKEN ì‚¬ìš©)
      - name: GHCR ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. OCI ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (íƒœê·¸, ë ˆì´ë¸”)
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # 1. ë¸Œëœì¹˜ ì´ë¦„ íƒœê·¸ (ì˜ˆ: main)
            type=ref,event=branch
            # 2. ì»¤ë°‹ í•´ì‹œ íƒœê·¸ (ì˜ˆ: sha-cf5126e...)
            type=sha,format=long,prefix=sha-
            # 3. Latest íƒœê·¸ (ë©”ì¸ ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
            type=raw,value=latest,enable={{is_default_branch}}

      # 5. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          outputs: type=image,oci-mediatypes=true

      # 6. ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„± (ë³´ì•ˆ ê°•í™”)
      - name: ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„±
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

  # ===================================================================
  # Job 3: SSHë¥¼ í†µí•œ Docker Compose ë°°í¬
  # testì™€ build-and-push ë‘˜ ë‹¤ ì„±ê³µí•´ì•¼ ì‹¤í–‰
  # ===================================================================
  deploy-to-server:
    name: ì„œë²„ì— Docker Compose ë°°í¬
    runs-on: ubuntu-latest
    needs: [test, build-and-push]    # í…ŒìŠ¤íŠ¸ì™€ ë¹Œë“œ ëª¨ë‘ ì„±ê³µ í›„ ì‹¤í–‰
    if: github.event_name == 'push'

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker-compose.yaml ì‚¬ìš©)
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. sshpass ì„¤ì¹˜ (SSH ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ìš©)
      - name: sshpass ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 3. docker-compose.yamlì„ ì„œë²„ë¡œ ë³µì‚¬
      - name: ë°°í¬ íŒŒì¼ ì„œë²„ë¡œ ë³µì‚¬
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          sshpass -e scp -o StrictHostKeyChecking=no docker-compose.yaml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      # 4. ì„œë²„ì—ì„œ .env íŒŒì¼ì˜ IMAGE_TAG ì—…ë°ì´íŠ¸
      - name: .env íŒŒì¼ ìƒì„± ë° ì—…ë°ì´íŠ¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            # .env íŒŒì¼ì´ ì—†ìœ¼ë©´ ìƒì„±
            touch .env

            # ê¸°ì¡´ ë‚´ìš©ì„ ìœ ì§€í•˜ë©´ì„œ í•„ìš”í•œ ë³€ìˆ˜ë§Œ ì—…ë°ì´íŠ¸
            # 1. DOCKER_REGISTRY ì—…ë°ì´íŠ¸
            if grep -q "^DOCKER_REGISTRY=" .env; then
              sed -i "s|^DOCKER_REGISTRY=.*|DOCKER_REGISTRY=${{ env.REGISTRY }}|" .env
            else
              echo "DOCKER_REGISTRY=${{ env.REGISTRY }}" >> .env
            fi

            # 2. DOCKER_IMAGE_NAME ì—…ë°ì´íŠ¸
            if grep -q "^DOCKER_IMAGE_NAME=" .env; then
              sed -i "s|^DOCKER_IMAGE_NAME=.*|DOCKER_IMAGE_NAME=${{ env.IMAGE_NAME }}|" .env
            else
              echo "DOCKER_IMAGE_NAME=${{ env.IMAGE_NAME }}" >> .env
            fi

            # 3. IMAGE_TAG ì—…ë°ì´íŠ¸
            if grep -q "^IMAGE_TAG=" .env; then
              sed -i "s|^IMAGE_TAG=.*|IMAGE_TAG=sha-${{ github.sha }}|" .env
            else
              echo "IMAGE_TAG=sha-${{ github.sha }}" >> .env
            fi

            echo "âœ… .env íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            cat .env
          EOF

      # ì„œë²„ ë¡œê·¸ì¸ (ì´ë¯¸ì§€ê°€ Publicì´ë©´ ìƒëµ ê°€ëŠ¥)
      - name: ì„œë²„ì—ì„œ GHCR ë¡œê·¸ì¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          EOF

      - name: Docker Compose ë°°í¬
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            # ìµœì‹  ìƒíƒœ ë°˜ì˜ì„ ìœ„í•´ down í›„ up (ë˜ëŠ” pull í›„ up -d)
            docker-compose pull app
            docker-compose up -d --remove-orphans
            docker image prune -f
          EOF

      # 7. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            echo "ğŸ“Š ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker-compose ps

            echo ""
            echo "ğŸ” ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):"
            docker-compose logs --tail=20 app
          EOF
