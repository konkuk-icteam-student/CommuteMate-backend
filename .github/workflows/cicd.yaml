name: CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
      - dev
      - feat/work-schedule
  pull_request:
    branches:
      - main
      - dev

env:
  REGISTRY: ghcr.io                        # GitHub Container Registry
  OWNER: ${{ github.repository_owner }}    # ì¡°ì§/ì‚¬ìš©ì ìë™ ì°¸ì¡°
  IMAGE_NAME: ${{ github.repository_owner }}/commutemate-server  # Helm valuesì˜ springApp.imageì™€ ì¼ì¹˜í•˜ë„ë¡ ì„¤ì •

jobs:
  # Job 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'           # Java 17 ì‚¬ìš©
          distribution: 'temurin'      # Eclipse Temurin ë°°í¬íŒ
          cache: 'gradle'              # Gradle ìºì‹± í™œì„±í™”

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 4. Gradle í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --no-daemon

      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ì—…ë¡œë“œ)
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/

  # Job 2: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCR í‘¸ì‹œ
  # OCI (Open Container Initiative) í‘œì¤€ ì´ë¯¸ì§€ ë¹Œë“œ
  # Kubernetes containerd, CRI-O ë“± ëª¨ë“  OCI í˜¸í™˜ ëŸ°íƒ€ì„ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥
  build-and-push:
    name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: test    # í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ ì‹¤í–‰
    # (deprecate)main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ë§Œ ì‹¤í–‰
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # GHCR ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read      # ì†ŒìŠ¤ ì½”ë“œ ì½ê¸°
      packages: write     # GHCRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      id-token: write
      attestations: write

    # ë‹¤ìŒ Jobì— ì „ë‹¬í•  ì¶œë ¥ê°’
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build-and-push.outputs.digest }}

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. BuildKit ì„¤ì • (OCI í‘œì¤€ ì´ë¯¸ì§€ ë¹Œë“œ)
      # containerd, CRI-O ë“± K8s ëŸ°íƒ€ì„ê³¼ ì™„ë²½ í˜¸í™˜
      - name: BuildKit ì„¤ì •
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      # 3. GHCR ë¡œê·¸ì¸ (GITHUB_TOKEN ì‚¬ìš©)
      - name: GHCR ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}           # GitHub ì‚¬ìš©ìëª…
          password: ${{ secrets.GITHUB_TOKEN }}
          # github actionì—ì„œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ë§ˆë‹¤ ì œê³µí•˜ëŠ” ì¼íšŒì„± í† í°,
          # jobs.build-and-push.permissions.packagesì—ì„œ ê¶Œí•œì„ ì§€ì •í•´ì„œ ì‚¬ìš©í•¨.

      # 4. OCI ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (íƒœê·¸, ë ˆì´ë¸”)
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # 1. ë¸Œëœì¹˜ ì´ë¦„ íƒœê·¸ (ì˜ˆ: main)
            type=ref,event=branch
            # 2. ì»¤ë°‹ í•´ì‹œ íƒœê·¸ (ì˜ˆ: sha-cf5126e...)
            type=sha,format=long,prefix=sha-
            # 3. Latest íƒœê·¸ (ë©”ì¸ ë¸Œëœì¹˜ì¼ ë•Œë§Œ)
            type=raw,value=latest,enable={{is_default_branch}}

      # 5. ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64
          outputs: type=image,oci-mediatypes=true

      # 6. ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„± (ë³´ì•ˆ ê°•í™”)
      - name: ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„±
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} # ìœ„ì—ì„œ ì„¤ì •í•œ env ì„¤ì •ë“¤
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

  # ===================================================================
  # Job 3: SSHë¥¼ í†µí•œ Docker Compose ë°°í¬
  # ===================================================================
  deploy-to-server:
    name: ì„œë²„ì— Docker Compose ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push    # ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ í›„ ì‹¤í–‰
    # (deprecate)main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ë§Œ ì‹¤í–‰ (ìš´ì˜ ë°°í¬)
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker-compose.yaml ì‚¬ìš©)
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. sshpass ì„¤ì¹˜ (SSH ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ìš©)
      - name: sshpass ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 3. docker-compose.yamlì„ ì„œë²„ë¡œ ë³µì‚¬
      - name: ë°°í¬ íŒŒì¼ ì„œë²„ë¡œ ë³µì‚¬
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          sshpass -e scp -o StrictHostKeyChecking=no docker-compose.yaml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      # 4. ì„œë²„ì—ì„œ .env íŒŒì¼ì˜ IMAGE_TAG ì—…ë°ì´íŠ¸
      - name: .env íŒŒì¼ ìƒì„± ë° ì—…ë°ì´íŠ¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            # .env íŒŒì¼ì— í•„ìš”í•œ ëª¨ë“  ë³€ìˆ˜ë¥¼ ë®ì–´ì”ë‹ˆë‹¤ (ê¸°ì¡´ íŒŒì¼ ë‚´ìš© ìœ ì§€ í•„ìš”ì‹œ ë¡œì§ ë³€ê²½ í•„ìš”)  
            echo "DOCKER_REGISTRY=${{ env.REGISTRY }}" > .env
            echo "DOCKER_IMAGE_NAME=${{ env.IMAGE_NAME }}" >> .env
            echo "IMAGE_TAG=sha-${{ github.sha }}" >> .env
          
            # DB ì •ë³´ ë“± ë¯¼ê°í•œ ì •ë³´ëŠ” ì„œë²„ì— ì´ë¯¸ ìˆë‹¤ê³  ê°€ì •í•˜ê³  ê±´ë“œë¦¬ì§€ ì•Šê±°ë‚˜,
            # í•„ìš”í•œ ê²½ìš° Github Secretsì—ì„œ ê°€ì ¸ì™€ì„œ ì—¬ê¸°ì„œ >> .env ë¡œ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤.
            # (ì˜ˆ: echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> .env)
          
            echo "âœ… .env íŒŒì¼ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            cat .env
          EOF

      # ì„œë²„ ë¡œê·¸ì¸ (ì´ë¯¸ì§€ê°€ Publicì´ë©´ ìƒëµ ê°€ëŠ¥)
      - name: ì„œë²„ì—ì„œ GHCR ë¡œê·¸ì¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          EOF

      - name: Docker Compose ë°°í¬
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
          
            # ìµœì‹  ìƒíƒœ ë°˜ì˜ì„ ìœ„í•´ down í›„ up (ë˜ëŠ” pull í›„ up -d)
            docker-compose pull app
            docker-compose up -d --remove-orphans
            docker image prune -f
          EOF

      # 7. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        env:
          SSHPASS: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            echo "ğŸ“Š ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker-compose ps

            echo ""
            echo "ğŸ” ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):"
            docker-compose logs --tail=20 app
          EOF
