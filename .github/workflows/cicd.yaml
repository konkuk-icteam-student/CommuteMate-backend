name: CI/CD íŒŒì´í”„ë¼ì¸

on:
  push:
    branches:
      - main
      - dev
      - feat/work-schedule
  pull_request:
    branches:
      - main
      - dev

env:
  REGISTRY: ghcr.io                        # GitHub Container Registry
  OWNER: ${{ github.repository_owner }}    # ì¡°ì§/ì‚¬ìš©ì ìë™ ì°¸ì¡°
  IMAGE_NAME: ${{ github.repository_owner }}/commutemate-server  # Helm valuesì˜ springApp.imageì™€ ì¼ì¹˜í•˜ë„ë¡ ì„¤ì •

jobs:
  # Job 1: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. JDK 17 ì„¤ì •
      - name: JDK 17 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          java-version: '17'           # Java 17 ì‚¬ìš©
          distribution: 'temurin'      # Eclipse Temurin ë°°í¬íŒ
          cache: 'gradle'              # Gradle ìºì‹± í™œì„±í™”

      # 3. Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
      - name: Gradle ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
        run: chmod +x gradlew

      # 4. Gradle í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        run: ./gradlew test --no-daemon

      # 5. í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ (ì‹¤íŒ¨ ì‹œì—ë„ ì—…ë¡œë“œ)
      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: build/test-results/

  # Job 2: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° GHCR í‘¸ì‹œ
  # OCI (Open Container Initiative) í‘œì¤€ ì´ë¯¸ì§€ ë¹Œë“œ
  # Kubernetes containerd, CRI-O ë“± ëª¨ë“  OCI í˜¸í™˜ ëŸ°íƒ€ì„ì—ì„œ ì‹¤í–‰ ê°€ëŠ¥
  build-and-push:
    name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
    runs-on: ubuntu-latest
    needs: test    # í…ŒìŠ¤íŠ¸ ì„±ê³µ í›„ ì‹¤í–‰
    # (deprecate)main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ë§Œ ì‹¤í–‰
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    # GHCR ì ‘ê·¼ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read      # ì†ŒìŠ¤ ì½”ë“œ ì½ê¸°
      packages: write     # GHCRì— ì´ë¯¸ì§€ í‘¸ì‹œ
      id-token: write
      attestations: write

    # ë‹¤ìŒ Jobì— ì „ë‹¬í•  ì¶œë ¥ê°’
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build-and-push.outputs.digest }}

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. BuildKit ì„¤ì • (OCI í‘œì¤€ ì´ë¯¸ì§€ ë¹Œë“œ)
      # containerd, CRI-O ë“± K8s ëŸ°íƒ€ì„ê³¼ ì™„ë²½ í˜¸í™˜
      - name: BuildKit ì„¤ì •
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:latest

      # 3. GHCR ë¡œê·¸ì¸ (GITHUB_TOKEN ì‚¬ìš©)
      - name: GHCR ë¡œê·¸ì¸
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}           # GitHub ì‚¬ìš©ìëª…
          password: ${{ secrets.GITHUB_TOKEN }}
            # github actionì—ì„œ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ë§ˆë‹¤ ì œê³µí•˜ëŠ” ì¼íšŒì„± í† í°,
            # jobs.build-and-push.permissions.packagesì—ì„œ ê¶Œí•œì„ ì§€ì •í•´ì„œ ì‚¬ìš©í•¨.

      # 4. OCI ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ (íƒœê·¸, ë ˆì´ë¸”)
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          # ê°™ì€ ì´ë¯¸ì§€ë¥¼ 3ê°€ì§€ ë°©ì‹ìœ¼ë¡œ ì°¸ì¡°í•  ìˆ˜ ìˆê²Œ í•˜ëŠ” tagë“¤
            # - ë¸Œëœì¹˜ëª… íƒœê·¸ (ì˜ˆ: main)
            # - ë¸Œëœì¹˜-ì»¤ë°‹SHA íƒœê·¸ (ì˜ˆ: main-a1b2c3d)
            # - í’€ì»¤ë°‹ SHA íƒœê·¸ (ì˜ˆ: a1b2c3d4e5f6...) â†’ values.yamlì— ë™ì¼ íƒœê·¸ ì‚¬ìš©
            # - latest íƒœê·¸ (main ë¸Œëœì¹˜ì—ë§Œ)
          tags: |
            type=ref,event=branch                             # ë¸Œëœì¹˜ëª… íƒœê·¸ (main)
            type=sha,prefix={{branch}}-                       # ë¸Œëœì¹˜-ì»¤ë°‹SHA íƒœê·¸ (main-a1b2c3d)
            type=sha,format=long,prefix=                      # í’€ì»¤ë°‹ SHA íƒœê·¸ (values.yamlì˜ springApp.imageì™€ ì¼ì¹˜)
            type=raw,value=latest,enable={{is_default_branch}} # latest íƒœê·¸ (main ë¸Œëœì¹˜ë§Œ)
          

      # 5. OCI í‘œì¤€ ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # BuildKitì„ ì‚¬ìš©í•˜ì—¬ OCI í‘œì¤€ ì¤€ìˆ˜ ì´ë¯¸ì§€ ìƒì„±
      - name: ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        id: build-and-push
        uses: docker/build-push-action@v5
        with:
          context: .                                    # ë¹Œë“œ ì»¨í…ìŠ¤íŠ¸ (í˜„ì¬ ë””ë ‰í† ë¦¬)
          push: true                                    # GHCRì— í‘¸ì‹œ
          tags: ${{ steps.meta.outputs.tags }}          # ìƒì„±ëœ íƒœê·¸
          labels: ${{ steps.meta.outputs.labels }}      # ìƒì„±ëœ ë ˆì´ë¸”
          cache-from: type=gha                          # GitHub Actions ìºì‹œì—ì„œ ì½ê¸°
          cache-to: type=gha,mode=max                   # GitHub Actions ìºì‹œì— ì“°ê¸° (ìµœëŒ€ ëª¨ë“œ)
          platforms: linux/amd64                        # ë¹Œë“œ í”Œë«í¼
          outputs: type=image,oci-mediatypes=true       # OCI ë¯¸ë””ì–´ íƒ€ì… ì‚¬ìš©

      # 6. ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„± (ë³´ì•ˆ ê°•í™”)
      - name: ì´ë¯¸ì§€ ì¶œì²˜ ì¦ëª… ìƒì„±
        uses: actions/attest-build-provenance@v1
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }} # ìœ„ì—ì„œ ì„¤ì •í•œ env ì„¤ì •ë“¤
          subject-digest: ${{ steps.build-and-push.outputs.digest }}
          push-to-registry: true

  # ===================================================================
  # Job 3: SSHë¥¼ í†µí•œ Docker Compose ë°°í¬
  # ===================================================================
  deploy-to-server:
    name: ì„œë²„ì— Docker Compose ë°°í¬
    runs-on: ubuntu-latest
    needs: build-and-push    # ì´ë¯¸ì§€ í‘¸ì‹œ ì„±ê³µ í›„ ì‹¤í–‰
    # (deprecate)main ë¸Œëœì¹˜ì— pushëœ ê²½ìš°ë§Œ ì‹¤í–‰ (ìš´ì˜ ë°°í¬)
    # if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      # 1. ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ (docker-compose.yaml ì‚¬ìš©)
      - name: ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      # 2. sshpass ì„¤ì¹˜ (SSH ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ìš©)
      - name: sshpass ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y sshpass

      # 3. docker-compose.yamlì„ ì„œë²„ë¡œ ë³µì‚¬
      - name: ë°°í¬ íŒŒì¼ ì„œë²„ë¡œ ë³µì‚¬
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "mkdir -p ${{ secrets.DEPLOY_PATH }}"
          sshpass -e scp -o StrictHostKeyChecking=no docker-compose.yaml ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:${{ secrets.DEPLOY_PATH }}/

      # 4. ì„œë²„ì—ì„œ .env íŒŒì¼ì˜ IMAGE_TAG ì—…ë°ì´íŠ¸
      - name: .env íŒŒì¼ IMAGE_TAG ì—…ë°ì´íŠ¸
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            # IMAGE_TAGë¥¼ í˜„ì¬ ì»¤ë°‹ SHAë¡œ ì—…ë°ì´íŠ¸
            if [ -f .env ]; then
              sed -i "s/^IMAGE_TAG=.*/IMAGE_TAG=sha-${{ github.sha }}/" .env
              echo "âœ… IMAGE_TAGê°€ sha-${{ github.sha }}ë¡œ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤."
            else
              echo "âŒ .env íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ì„œë²„ ì´ˆê¸° ì„¸íŒ…ì´ í•„ìš”í•©ë‹ˆë‹¤."
              exit 1
            fi
          EOF

      # 5. GHCR ë¡œê·¸ì¸ (ì„œë²„ì—ì„œ)
      - name: ì„œë²„ì—ì„œ GHCR ë¡œê·¸ì¸
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin
          EOF

      # 6. Docker Composeë¡œ ë°°í¬
      - name: Docker Compose ë°°í¬
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            echo "ğŸ”„ ìµœì‹  ì´ë¯¸ì§€ Pull ì¤‘..."
            docker-compose pull app

            echo "ğŸš€ ì„œë¹„ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            docker-compose up -d

            echo "ğŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬..."
            docker image prune -f

            echo "âœ… ë°°í¬ ì™„ë£Œ!"
          EOF

      # 7. ë°°í¬ ìƒíƒœ í™•ì¸
      - name: ë°°í¬ ìƒíƒœ í™•ì¸
        env:
          SSH_PASSWORD: ${{ secrets.SSH_PASSWORD }}
        run: |
          sshpass -e ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}
            echo "ğŸ“Š ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ:"
            docker-compose ps

            echo ""
            echo "ğŸ” ìµœê·¼ ë¡œê·¸ (ë§ˆì§€ë§‰ 20ì¤„):"
            docker-compose logs --tail=20 app
          EOF
